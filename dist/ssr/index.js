var H=Object.defineProperty;var E=(e,r)=>()=>(e&&(r=e(e=0)),r);var K=(e,r)=>{for(var t in r)H(e,t,{get:r[t],enumerable:!0})};var u,L,M,j,b,O,I,T,y=E(()=>{u=e=>e,L=u,M=u,j=u,b=u,O=u,I=u,T=u});var q={};K(q,{default:()=>he});var he,B=E(()=>{y();he=L(({app:e,resolve:r,render:t,serve:s})=>{e.get(r.urlPath("*"),(n,o)=>{o.setHeader("Content-Type","text/html"),t({req:n,res:o}).then(a=>{o.send(a)}).catch(a=>{a.url?a.code?o.redirect(a.code,a.url):o.redirect(a.url):a.code===404?o.status(404).send("404 | Page Not Found"):o.status(500).send("500 | Internal Server Error")})})})});import{join as S,basename as ve,isAbsolute as Re}from"node:path";import{readFileSync as _e}from"node:fs";import{fileURLToPath as we}from"node:url";import{renderToString as ye}from"vue/server-renderer";import Ne from"serialize-javascript";import Ae from"./render-template.js";import Ce from"./server/server-entry.js";y();import v from"express";import ie from"express-session";import le from"compression";import{Router as te}from"express";import J from"mssql";import X from"dotenv";X.config();var Y={user:"sa",password:"1234",server:"192.168.1.200",database:"FORTRESS_LIVE",options:{encrypt:!1,trustServerCertificate:!0}},d=null,D=null;function Z(e){return new Promise(r=>setTimeout(r,e))}async function p(e=5,r=3e3){if(d)return d;let t=0;for(;t<e;)try{return console.log(`[MSSQL] \u{1F50C} Connecting (attempt ${t+1}/${e})...`),d=await J.connect(Y),console.log("[MSSQL] \u2705 Connected to database"),ee(),d}catch(s){if(console.error(`[MSSQL] \u274C Connection failed (attempt ${t+1}):`,s.message),t++,t<e)console.log(`[MSSQL] \u23F3 Retrying in ${r/1e3}s...`),await Z(r);else throw console.error("[MSSQL] \u274C All connection attempts failed. Server startup aborted."),s}}function ee(e=300*1e3){D||(console.log(`[MSSQL] \u{1FA7A} Starting keep-alive ping every ${e/1e3/60} min`),D=setInterval(async()=>{try{if(!d)return;await d.request().query("SELECT 1"),console.log("[MSSQL] \u2705 Keep-alive ping successful")}catch(r){console.error("[MSSQL] \u26A0\uFE0F Keep-alive ping failed:",r.message)}},e))}import re from"dotenv";re.config();var g=te();g.post("/login",async(e,r)=>{let{username:t,password:s}=e.body;if(!t||!s)return r.status(400).json({success:!1,message:"Missing credentials"});try{let o=await(await p()).request().input("login",t).input("password",s).query(`
      SELECT Login, Name
      FROM dbo.VW_WA_UserList
      WHERE Login = @login AND Password = @password
    `);if(o.recordset.length===0)return r.status(401).json({success:!1,message:"Invalid credentials"});let a={username:o.recordset[0].Login,name:o.recordset[0].Name};return e.session.user=a,r.json({success:!0,message:"Login successful",user:a})}catch(n){return console.error("[LOGIN ERROR]",n),r.status(500).json({success:!1,error:"Internal Server Error"})}});g.post("/logout",(e,r)=>{e.session.destroy(t=>{if(t)return console.error("Logout error:",t),r.status(500).json({success:!1,message:"Logout failed"});r.clearCookie("connect.sid"),r.json({success:!0,message:"Logged out successfully"})})});g.get("/session",(e,r)=>e.session?.user?r.json({loggedIn:!!e.session?.user,user:e.session?.user||null}):r.json({loggedIn:!1}));var V=g;import{Router as se}from"express";var $=se();$.get("/itemlist",async(e,r)=>{try{let s=await(await p()).request().query(`
      SELECT * FROM VW_WA_ItemList
    `);return r.json({success:!0,data:s.recordset})}catch(t){return console.error("[DB ERROR]",t),r.status(500).json({success:!1,error:"Database query failed"})}});var x=$;import oe from"express";import F from"soap";import ne from"util";import ae from"http";var f=oe.Router();function l(e,r){let t=new Date().toISOString();console.log(`
\u{1F9ED} [${t}] ${e}:`),console.log(ne.inspect(r,{colors:!0,depth:null,compact:!1}))}var ce=new ae.Agent({keepAlive:!1,maxSockets:1}),N={};async function h(e="Service_Item_Card"){if(N[e])return N[e];let r="fortress\\administrator",t="P@ssw0rdNAV25***",s="SRVNAV",n=`http://192.168.1.200:7047/DynamicsNAV110/WS/FORTRESS_LIVE/Page/${e}?wsdl`;try{let o=new F.NTLMSecurity({username:r,password:t,domain:s}),a={},i={httpAgent:ce};o.addHeaders(a),o.addOptions(i);let c=await F.createClientAsync(n,{wsdl_headers:a,wsdl_options:i});return c.setSecurity(o),c.on("request",w=>{console.log(`
\u{1F4E4} NAV SOAP REQUEST:
`,w)}),c.on("response",w=>{console.log(`
\u{1F4E5} NAV SOAP RESPONSE:
`,w)}),N[e]=c,l("\u2705 NTLM NAV SOAP Client Ready",{WSDL_URL:n,NAVUSERNAME:r,DOMAIN:s}),c}catch(o){throw console.error("\u274C Failed to create NTLM NAV SOAP client:",o),o}}f.get("/service-items",async(e,r)=>{let{itemNo:t,serialNo:s}=e.query;if(!t||!s)return r.status(400).json({success:!1,error:"Both itemNo and serialNo are required."});try{let n=await h("Service_Item_Card"),o={filter:[{Field:"Item_No",Criteria:t},{Field:"Serial_No",Criteria:s}],setSize:1};l("\u{1F4E8} NAV ReadMultiple params",o);let[a]=await n.ReadMultipleAsync(o);l("\u{1F4EC} NAV ReadMultiple result",a);let i=a?.ReadMultiple_Result?.Service_Item_Card?.[0];if(!i)return r.status(404).json({success:!1,message:`No service item found for Item_No=${t} and Serial_No=${s}.`});r.json({success:!0,data:i})}catch(n){console.error("\u274C NAV Fetch error:",n),r.status(500).json({success:!1,error:n.message})}});f.post("/service-items",async(e,r)=>{let t=e.body;if(console.log(`
\u{1F4E8} Received Service Item form data:`,t),!t?.itemNumber||!t?.serialNumber)return r.status(400).json({success:!1,error:"Item Number and Serial Number are required."});try{let s=await h("Service_Item_Card"),n={...t};delete n.itemNumber,delete n.serialNumber,delete n.isNew,l("\u{1F680} NAV SOAP Payload",n);let[o]=t.isNew?await s.CreateAsync({Service_Item_Card:n}):await s.UpdateAsync({Service_Item_Card:n});l("\u{1F4E6} NAV SOAP Raw Response",o);let a=o?.Service_Item_Card||o?.Create_Result?.Service_Item_Card||o?.Update_Result?.Service_Item_Card||null;r.json({success:!0,data:a})}catch(s){console.error("\u274C NAV SOAP error:",s),r.status(500).json({success:!1,error:s.message})}});f.get("/customers",async(e,r)=>{let t=e.query.search;if(!t)return r.json({success:!0,data:[]});try{let s=await h("Customer_Card"),n={filter:[{Field:"Search_Name",Criteria:`*${t}*`}],setSize:10};l("\u{1F4E8} NAV Customer Search params",n);let[o]=await s.ReadMultipleAsync(n);l("\u{1F4EC} NAV Customer Search result",o);let a=o?.ReadMultiple_Result?.Customer_Card||o?.ReadMultiple_Result?.CustomerCard||[];r.json({success:!0,data:a})}catch(s){console.error("\u274C Error fetching customers:",s),r.status(500).json({success:!1,error:s.message})}});f.post("/customers",async(e,r)=>{let t=e.body;if(l("\u{1F4E8} Received Customer Form Data",t),!t.customerName)return r.status(400).json({success:!1,error:"Customer Name is required."});try{let s=await h("Customer_Card"),n={Name:t.customerName,Title:t.title||"",ID_Number:t.idNumber||"",Customer_Group:t.customerGroup||"",Customer_Type_MRA:t.customerType||"",Address:t.address1||"",Address_2:t.address2||"",Post_Code:t.postCode||"",City:t.city||"",Country_Region_Code:t.country||"",Phone_No:t.phoneNumber||"",E_Mail:t.email||"",Fax_No:t.faxNumber||""};t.customerNumber&&(n.No=t.customerNumber),l("\u{1F680} NAV SOAP Create Payload",n);let[o]=await s.CreateAsync({Customer_Card:n});l("\u{1F4E6} NAV SOAP Raw Response",o);let a=o?.Customer_Card||o?.Create_Result?.Customer_Card||null;if(!a)throw new Error("NAV did not return a valid Customer Card.");r.json({success:!0,data:a})}catch(s){console.error("\u274C NAV SOAP Error:",s),r.status(500).json({success:!1,error:s.message})}});var Q=f;var k=M(async()=>{console.log("[SSR] \u23F3 Connecting to MSSQL..."),await p(),console.log("[SSR] \u2705 MSSQL ready. Starting app...");let e=v();return e.disable("x-powered-by"),e.use((r,t,s)=>{t.set("Cache-Control","no-store"),s()}),e.use(le()),e.use(v.json()),e.use(v.urlencoded({extended:!0})),e.use(ie({secret:"4b7c9d8e2f1a3b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c",resave:!1,saveUninitialized:!1,cookie:{httpOnly:!0,secure:!1,sameSite:"lax"}})),e.use("/api/login",V),e.use("/soap",Q),e.use("/api/db",x),e.use((r,t,s)=>{let n=["/login"],a=["/public","/favicon","/src","/js","/css","/assets","/img","/@vite","/@fs","/@id","/__vite","/.quasar","/node_modules"].some(c=>r.path.startsWith(c)),i=n.some(c=>r.path.startsWith(c));if(r.path.startsWith("/api/login")||r.path.startsWith("/api/logout")||a||i)return s();if(!r.session?.user)return console.warn(`\u274C Unauthorized access attempt: ${r.path}`),t.redirect("/login");s()}),e.post("/api/logout",(r,t)=>{r.session.destroy(s=>{if(s)return console.error("Logout error:",s),t.status(500).json({success:!1,message:"Logout failed"});t.clearCookie("connect.sid"),t.json({success:!0,message:"Logged out successfully"})})}),e}),ct=j(({app:e})=>r=>{e.use(r)}),U=b(({app:e,devHttpsApp:r,port:t})=>(r||e).listen(t,()=>{console.log("Server listening at port "+t)})),it=O(({listenResult:e})=>e.close()),ue=/\.js$/,de=/\.css$/,pe=/\.woff$/,me=/\.woff2$/,fe=/\.gif$/,Se=/\.jpe?g$/,ge=/\.png$/,W=I(({app:e,resolve:r})=>({urlPath:t="/",pathToServe:s=".",opts:n={}})=>{let o=v.static(r.public(s),{maxAge:0,...n});e.use(r.urlPath(t),o)}),A=T(e=>ue.test(e)?`<link rel="modulepreload" href="${e}" crossorigin>`:de.test(e)?`<link rel="stylesheet" href="${e}" crossorigin>`:pe.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff" crossorigin>`:me.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff2" crossorigin>`:fe.test(e)?`<link rel="preload" href="${e}" as="image" type="image/gif" crossorigin>`:Se.test(e)?`<link rel="preload" href="${e}" as="image" type="image/jpeg" crossorigin>`:ge.test(e)?`<link rel="preload" href="${e}" as="image" type="image/png" crossorigin>`:"");function C(e){return Promise.all([Promise.resolve().then(()=>(B(),q))]).then(async r=>{let t=r.map(s=>s.default);for(let s=0;s<t.length;s++)try{await t[s](e)}catch(n){console.error("[Quasar SSR] middleware error:",n);return}})}var Pe=process.env.PORT||3e3,Ee=/\/\//g,R="/",Le=R==="/"?e=>e||"/":e=>e?(R+e).replace(Ee,"/"):R,_=we(new URL(".",import.meta.url)),G=S(_,"client"),P=JSON.parse(_e(S(_,"./quasar.manifest.json"),"utf-8"));function Me(){let e=S(...arguments);return Re(e)===!0?e:S(G,e)}function je(e,r){let t="",s=new Set;return e.forEach(n=>{let o=P[n];o!==void 0&&o.forEach(a=>{if(s.has(a)===!0)return;s.add(a);let i=ve(a);if(P[i]!==void 0)for(let c of P[i])s.has(c)===!1&&(t+=A(c,r),s.add(c));t+=A(a,r)})}),t}var be="document.currentScript.remove()";function Oe(e){let r=e.nonce!==void 0?' nonce="'+e.nonce+'"':"",t=Ne(e.state,{isJSON:!0});return"<script"+r+">window.__INITIAL_STATE__="+t+";"+be+"</script>"}async function Ie(e){let r=[];Object.assign(e,{_meta:{},onRendered:t=>{r.push(t)}});try{let t=await Ce(e),s=await ye(t,e);return r.forEach(n=>{n()}),typeof e.rendered=="function"&&e.rendered(),e._meta.runtimePageContent=s,e.state!==void 0&&(e._meta.headTags=Oe(e)+e._meta.headTags),e._meta.endingHeadTags+=je(e.modules,{ssrContext:e}),Ae(e)}catch(t){throw t}}var m={port:Pe,resolve:{urlPath:Le,root(){return S(_,...arguments)},public:Me},publicPath:R,folders:{root:_,public:G},render:Ie},Te=await k(m);m.app=Te;var z=await W(m);m.serve={static:z};await z({urlPath:"/",pathToServe:"."});await C(m);var De=await U(m),wt=De?.handler;export{Te as app,wt as handler,De as listenResult};
