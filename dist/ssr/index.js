var H=Object.defineProperty;var P=(e,r)=>()=>(e&&(r=e(e=0)),r);var K=(e,r)=>{for(var t in r)H(e,t,{get:r[t],enumerable:!0})};var u,L,M,j,O,b,I,T,A=P(()=>{u=e=>e,L=u,M=u,j=u,O=u,b=u,I=u,T=u});var q={};K(q,{default:()=>Se});var Se,B=P(()=>{A();Se=L(({app:e,resolve:r,render:t,serve:s})=>{e.get(r.urlPath("*"),(a,o)=>{o.setHeader("Content-Type","text/html"),t({req:a,res:o}).then(n=>{o.send(n)}).catch(n=>{n.url?n.code?o.redirect(n.code,n.url):o.redirect(n.url):n.code===404?o.status(404).send("404 | Page Not Found"):o.status(500).send("500 | Internal Server Error")})})})});import{join as S,basename as ge,isAbsolute as _e}from"node:path";import{readFileSync as Re}from"node:fs";import{fileURLToPath as ve}from"node:url";import{renderToString as he}from"vue/server-renderer";import we from"serialize-javascript";import ye from"./render-template.js";import Ae from"./server/server-entry.js";A();import v from"express";import ae from"express-session";import ce from"compression";import{Router as te}from"express";import J from"mssql";import X from"dotenv";X.config();var Y={user:"sa",password:"1234",server:"192.168.1.200",database:"FORTRESS_LIVE",options:{encrypt:!1,trustServerCertificate:!0}},d=null,D=null;function Z(e){return new Promise(r=>setTimeout(r,e))}async function p(e=5,r=3e3){if(d)return d;let t=0;for(;t<e;)try{return console.log(`[MSSQL] \u{1F50C} Connecting (attempt ${t+1}/${e})...`),d=await J.connect(Y),console.log("[MSSQL] \u2705 Connected to database"),ee(),d}catch(s){if(console.error(`[MSSQL] \u274C Connection failed (attempt ${t+1}):`,s.message),t++,t<e)console.log(`[MSSQL] \u23F3 Retrying in ${r/1e3}s...`),await Z(r);else throw console.error("[MSSQL] \u274C All connection attempts failed. Server startup aborted."),s}}function ee(e=300*1e3){D||(console.log(`[MSSQL] \u{1FA7A} Starting keep-alive ping every ${e/1e3/60} min`),D=setInterval(async()=>{try{if(!d)return;await d.request().query("SELECT 1"),console.log("[MSSQL] \u2705 Keep-alive ping successful")}catch(r){console.error("[MSSQL] \u26A0\uFE0F Keep-alive ping failed:",r.message)}},e))}import re from"dotenv";re.config();var _=te();_.post("/login",async(e,r)=>{let{username:t,password:s}=e.body;if(!t||!s)return r.status(400).json({success:!1,message:"Missing credentials"});try{let o=await(await p()).request().input("login",t).input("password",s).query(`
      SELECT Login, Name
      FROM dbo.VW_WA_UserList
      WHERE Login = @login AND Password = @password
    `);if(o.recordset.length===0)return r.status(401).json({success:!1,message:"Invalid credentials"});let n={username:o.recordset[0].Login,name:o.recordset[0].Name};return e.session.user=n,r.json({success:!0,message:"Login successful",user:n})}catch(a){return console.error("[LOGIN ERROR]",a),r.status(500).json({success:!1,error:"Internal Server Error"})}});_.post("/logout",(e,r)=>{e.session.destroy(t=>{if(t)return console.error("Logout error:",t),r.status(500).json({success:!1,message:"Logout failed"});r.clearCookie("connect.sid"),r.json({success:!0,message:"Logged out successfully"})})});_.get("/session",(e,r)=>e.session?.user?r.json({loggedIn:!!e.session?.user,user:e.session?.user||null}):r.json({loggedIn:!1}));var $=_;import{Router as se}from"express";var V=se();V.get("/itemlist",async(e,r)=>{try{let s=await(await p()).request().query(`
      SELECT * FROM VW_WA_ItemList
    `);return r.json({success:!0,data:s.recordset})}catch(t){return console.error("[DB ERROR]",t),r.status(500).json({success:!1,error:"Database query failed"})}});var x=V;import oe from"express";import U from"soap";import ne from"util";var f=oe.Router();function c(e,r){let t=new Date().toISOString();console.log(`
\u{1F9ED} [${t}] ${e}:`),console.log(ne.inspect(r,{colors:!0,depth:null,compact:!1}))}async function R(e="Service_Item_Card"){let r="administrator",t="P@ssw0rdNAV25***",s="FORTRESS",o=`http://srvnav:7047/DynamicsNAV110/WS/FORTRESS_LIVE/Page/Service_Item_Card?wsdl/DynamicsNAV110/WS/FORTRESS_LIVE/Page/${e}?wsdl`;try{let n=new U.NTLMSecurity({username:r,password:t,domain:s,negotiate:!0}),i={},l={};n.addHeaders(i),n.addOptions(l);let g=await U.createClientAsync(o,{wsdl_headers:i,wsdl_options:l});return g.setSecurity(n),g.on("request",y=>{console.log(`
\u{1F4E4} NAV SOAP REQUEST:
`,y)}),g.on("response",y=>{console.log(`
\u{1F4E5} NAV SOAP RESPONSE:
`,y)}),c("\u2705 NAV SOAP Client created",{WSDL_URL:o,NAVUSERNAME:r,DOMAIN:s}),g}catch(n){throw console.error("\u274C Failed to create NAV SOAP client:",n),n}}f.get("/service-items",async(e,r)=>{let{itemNo:t,serialNo:s}=e.query;if(!t||!s)return r.status(400).json({success:!1,error:"itemNo and serialNo are required."});try{let a=await R("Service_Item_Card"),o={filter:[{Field:"No",Criteria:t},{Field:"Serial_No",Criteria:s}],setSize:1};c("\u{1F4E8} NAV ReadMultiple params",o);let[n]=await a.ReadMultipleAsync(o);c("\u{1F4EC} NAV ReadMultiple result",n);let i=n?.ReadMultiple_Result?.Service_Item_Card?.[0]||null;if(!i)return r.status(404).json({success:!1,message:`No service item found for ${t} / ${s}`});r.json({success:!0,data:i})}catch(a){console.error("\u274C NAV Fetch error:",a),r.status(500).json({success:!1,error:a.message})}});f.post("/service-items",async(e,r)=>{let t=e.body;if(c("\u{1F4E8} Received Service Item form data",t),!t?.No||!t?.Serial_No)return r.status(400).json({success:!1,error:"No and Serial_No are required."});try{let s=await R("Service_Item_Card"),a={...t};delete a.isNew,c("\u{1F680} NAV SOAP Payload",a);let[o]=t.isNew?await s.CreateAsync({Service_Item_Card:a}):await s.UpdateAsync({Service_Item_Card:a});c("\u{1F4E6} NAV SOAP Raw Response",o);let n=o?.Create_Result?.Service_Item_Card||o?.Update_Result?.Service_Item_Card||null;r.json({success:!0,data:n})}catch(s){console.error("\u274C NAV SOAP error:",s),r.status(500).json({success:!1,error:s.message})}});f.get("/customers",async(e,r)=>{let t=e.query.search;if(!t)return r.json({success:!0,data:[]});try{let s=await R("Customer_Card"),a={filter:[{Field:"Search_Name",Criteria:`*${t}*`}],setSize:10};c("\u{1F4E8} NAV Customer Search params",a);let[o]=await s.ReadMultipleAsync(a);c("\u{1F4EC} NAV Customer Search result",o);let n=o?.ReadMultiple_Result?.Customer_Card||o?.ReadMultiple_Result?.CustomerCard||[];r.json({success:!0,data:n})}catch(s){console.error("\u274C Error fetching customers:",s),r.status(500).json({success:!1,error:s.message})}});f.post("/customers",async(e,r)=>{let t=e.body;if(c("\u{1F4E8} Received Customer Form Data",t),!t.customerName)return r.status(400).json({success:!1,error:"Customer Name is required."});try{let s=await R("Customer_Card"),a={Name:t.customerName,Title:t.title||"",ID_Number:t.idNumber||"",Customer_Group:t.customerGroup||"",Customer_Type_MRA:t.customerType||"",Address:t.address1||"",Address_2:t.address2||"",Post_Code:t.postCode||"",City:t.city||"",Country_Region_Code:t.country||"",Phone_No:t.phoneNumber||"",E_Mail:t.email||"",Fax_No:t.faxNumber||""};t.customerNumber&&(a.No=t.customerNumber),c("\u{1F680} NAV SOAP Payload",a);let[o]=t.customerNumber?await s.UpdateAsync({Customer_Card:a}):await s.CreateAsync({Customer_Card:a});c("\u{1F4E6} NAV SOAP Raw Response",o);let n=o?.Create_Result?.Customer_Card||o?.Update_Result?.Customer_Card||o?.Customer_Card||null;if(!n)throw new Error("NAV did not return a valid Customer_Card.");r.json({success:!0,data:n})}catch(s){console.error("\u274C NAV SOAP Error:",s),r.status(500).json({success:!1,error:s.message})}});var F=f;var Q=M(async()=>{console.log("[SSR] \u23F3 Connecting to MSSQL..."),await p(),console.log("[SSR] \u2705 MSSQL ready. Starting app...");let e=v();return e.disable("x-powered-by"),e.use((r,t,s)=>{t.set("Cache-Control","no-store"),s()}),e.use(ce()),e.use(v.json()),e.use(v.urlencoded({extended:!0})),e.use(ae({secret:"4b7c9d8e2f1a3b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c",resave:!1,saveUninitialized:!1,cookie:{httpOnly:!0,secure:!1,sameSite:"lax"}})),e.use("/api/login",$),e.use("/soap",F),e.use("/api/db",x),e.use((r,t,s)=>{let a=["/login"],n=["/public","/favicon","/src","/js","/css","/assets","/img","/@vite","/@fs","/@id","/__vite","/.quasar","/node_modules"].some(l=>r.path.startsWith(l)),i=a.some(l=>r.path.startsWith(l));if(r.path.startsWith("/api/login")||r.path.startsWith("/api/logout")||n||i)return s();if(!r.session?.user)return console.warn(`\u274C Unauthorized access attempt: ${r.path}`),t.redirect("/login");s()}),e.post("/api/logout",(r,t)=>{r.session.destroy(s=>{if(s)return console.error("Logout error:",s),t.status(500).json({success:!1,message:"Logout failed"});t.clearCookie("connect.sid"),t.json({success:!0,message:"Logged out successfully"})})}),e}),ot=j(({app:e})=>r=>{e.use(r)}),k=O(({app:e,devHttpsApp:r,port:t})=>(r||e).listen(t,()=>{console.log("Server listening at port "+t)})),nt=b(({listenResult:e})=>e.close()),ie=/\.js$/,le=/\.css$/,ue=/\.woff$/,de=/\.woff2$/,pe=/\.gif$/,me=/\.jpe?g$/,fe=/\.png$/,W=I(({app:e,resolve:r})=>({urlPath:t="/",pathToServe:s=".",opts:a={}})=>{let o=v.static(r.public(s),{maxAge:0,...a});e.use(r.urlPath(t),o)}),N=T(e=>ie.test(e)?`<link rel="modulepreload" href="${e}" crossorigin>`:le.test(e)?`<link rel="stylesheet" href="${e}" crossorigin>`:ue.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff" crossorigin>`:de.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff2" crossorigin>`:pe.test(e)?`<link rel="preload" href="${e}" as="image" type="image/gif" crossorigin>`:me.test(e)?`<link rel="preload" href="${e}" as="image" type="image/jpeg" crossorigin>`:fe.test(e)?`<link rel="preload" href="${e}" as="image" type="image/png" crossorigin>`:"");function C(e){return Promise.all([Promise.resolve().then(()=>(B(),q))]).then(async r=>{let t=r.map(s=>s.default);for(let s=0;s<t.length;s++)try{await t[s](e)}catch(a){console.error("[Quasar SSR] middleware error:",a);return}})}var Ne=process.env.PORT||3e3,Ce=/\/\//g,h="/",Ee=h==="/"?e=>e||"/":e=>e?(h+e).replace(Ce,"/"):h,w=ve(new URL(".",import.meta.url)),G=S(w,"client"),E=JSON.parse(Re(S(w,"./quasar.manifest.json"),"utf-8"));function Pe(){let e=S(...arguments);return _e(e)===!0?e:S(G,e)}function Le(e,r){let t="",s=new Set;return e.forEach(a=>{let o=E[a];o!==void 0&&o.forEach(n=>{if(s.has(n)===!0)return;s.add(n);let i=ge(n);if(E[i]!==void 0)for(let l of E[i])s.has(l)===!1&&(t+=N(l,r),s.add(l));t+=N(n,r)})}),t}var Me="document.currentScript.remove()";function je(e){let r=e.nonce!==void 0?' nonce="'+e.nonce+'"':"",t=we(e.state,{isJSON:!0});return"<script"+r+">window.__INITIAL_STATE__="+t+";"+Me+"</script>"}async function Oe(e){let r=[];Object.assign(e,{_meta:{},onRendered:t=>{r.push(t)}});try{let t=await Ae(e),s=await he(t,e);return r.forEach(a=>{a()}),typeof e.rendered=="function"&&e.rendered(),e._meta.runtimePageContent=s,e.state!==void 0&&(e._meta.headTags=je(e)+e._meta.headTags),e._meta.endingHeadTags+=Le(e.modules,{ssrContext:e}),ye(e)}catch(t){throw t}}var m={port:Ne,resolve:{urlPath:Ee,root(){return S(w,...arguments)},public:Pe},publicPath:h,folders:{root:w,public:G},render:Oe},be=await Q(m);m.app=be;var z=await W(m);m.serve={static:z};await z({urlPath:"/",pathToServe:"."});await C(m);var Ie=await k(m),Rt=Ie?.handler;export{be as app,Rt as handler,Ie as listenResult};
