var K=Object.defineProperty;var j=(e,r)=>()=>(e&&(r=e(e=0)),r);var J=(e,r)=>{for(var t in r)K(e,t,{get:r[t],enumerable:!0})};var u,b,M,O,I,T,$,D,A=j(()=>{u=e=>e,b=u,M=u,O=u,I=u,T=u,$=u,D=u});var B={};J(B,{default:()=>he});var he,G=j(()=>{A();he=b(({app:e,resolve:r,render:t,serve:s})=>{e.get(r.urlPath("*"),(o,n)=>{n.setHeader("Content-Type","text/html"),t({req:o,res:n}).then(a=>{n.send(a)}).catch(a=>{a.url?a.code?n.redirect(a.code,a.url):n.redirect(a.url):a.code===404?n.status(404).send("404 | Page Not Found"):n.status(500).send("500 | Internal Server Error")})})})});import{join as v,basename as Re,isAbsolute as we}from"node:path";import{readFileSync as ye}from"node:fs";import{fileURLToPath as _e}from"node:url";import{renderToString as Ae}from"vue/server-renderer";import Ne from"serialize-javascript";import Ce from"./render-template.js";import Pe from"./server/server-entry.js";A();import w from"express";import le from"express-session";import ue from"compression";import{Router as re}from"express";import X from"mssql";import Y from"dotenv";Y.config();var Z={user:"sa",password:"1234",server:"192.168.1.200",database:"FORTRESS_LIVE",options:{encrypt:!1,trustServerCertificate:!0}},m=null,V=null;function ee(e){return new Promise(r=>setTimeout(r,e))}async function p(e=5,r=3e3){if(m)return m;let t=0;for(;t<e;)try{return console.log(`[MSSQL] \u{1F50C} Connecting (attempt ${t+1}/${e})...`),m=await X.connect(Z),console.log("[MSSQL] \u2705 Connected to database"),te(),m}catch(s){if(console.error(`[MSSQL] \u274C Connection failed (attempt ${t+1}):`,s.message),t++,t<e)console.log(`[MSSQL] \u23F3 Retrying in ${r/1e3}s...`),await ee(r);else throw console.error("[MSSQL] \u274C All connection attempts failed. Server startup aborted."),s}}function te(e=300*1e3){V||(console.log(`[MSSQL] \u{1FA7A} Starting keep-alive ping every ${e/1e3/60} min`),V=setInterval(async()=>{try{if(!m)return;await m.request().query("SELECT 1"),console.log("[MSSQL] \u2705 Keep-alive ping successful")}catch(r){console.error("[MSSQL] \u26A0\uFE0F Keep-alive ping failed:",r.message)}},e))}import se from"dotenv";se.config();var h=re();h.post("/login",async(e,r)=>{let{username:t,password:s}=e.body;if(!t||!s)return r.status(400).json({success:!1,message:"Missing credentials"});try{let n=await(await p()).request().input("login",t).input("password",s).query(`
      SELECT Login, Name
      FROM dbo.VW_WA_UserList
      WHERE Login = @login AND Password = @password
    `);if(n.recordset.length===0)return r.status(401).json({success:!1,message:"Invalid credentials"});let a={username:n.recordset[0].Login,name:n.recordset[0].Name};return e.session.user=a,r.json({success:!0,message:"Login successful",user:a})}catch(o){return console.error("[LOGIN ERROR]",o),r.status(500).json({success:!1,error:"Internal Server Error"})}});h.post("/logout",(e,r)=>{e.session.destroy(t=>{if(t)return console.error("Logout error:",t),r.status(500).json({success:!1,message:"Logout failed"});r.clearCookie("connect.sid"),r.json({success:!0,message:"Logged out successfully"})})});h.get("/session",(e,r)=>e.session?.user?r.json({loggedIn:!!e.session?.user,user:e.session?.user||null}):r.json({loggedIn:!1}));var x=h;import{Router as oe}from"express";var F=oe();F.get("/itemlist",async(e,r)=>{try{let s=await(await p()).request().query(`
      SELECT * FROM VW_WA_ItemList
    `);return r.json({success:!0,data:s.recordset})}catch(t){return console.error("[DB ERROR]",t),r.status(500).json({success:!1,error:"Database query failed"})}});var Q=F;import ne from"express";import N from"soap";import ae from"util";import ce from"http";var g=ne.Router();function i(e,r){let t=new Date().toISOString();console.log(`
\u{1F9ED} [${t}] ${e}:`),console.log(ae.inspect(r,{colors:!0,depth:null,compact:!1}))}var ie=new ce.Agent({keepAlive:!1,maxSockets:1}),C={};async function R(e="Service_Item_Card",r="basic"){let t=`${e}_${r}`;if(C[t])return C[t];let s="fortress\\administrator",o="P@ssw0rdNAV25***",n="SRVNAV",a=`http://192.168.1.200:7047/DynamicsNAV110/WS/FORTRESS_LIVE/Page/${e}?wsdl`;try{let c={},l={httpAgent:ie},d=await N.createClientAsync(a,{wsdl_headers:c,wsdl_options:l});if(r==="ntlm"){let S=new N.NTLMSecurity({username:s,password:o,domain:n});d.setSecurity(S)}else d.setSecurity(new N.BasicAuthSecurity(s,o));return d.on("request",S=>{console.log(`
\u{1F4E4} NAV SOAP REQUEST:
`,S)}),d.on("response",S=>{console.log(`
\u{1F4E5} NAV SOAP RESPONSE:
`,S)}),C[t]=d,i("\u2705 NAV SOAP Client Ready",{WSDL_URL:a,NAVUSERNAME:s,DOMAIN:n,AUTH:r.toUpperCase()}),d}catch(c){throw console.error("\u274C Failed to create NAV SOAP client:",c),c}}g.get("/service-items",async(e,r)=>{let{itemNo:t,serialNo:s}=e.query;if(!t||!s)return r.status(400).json({success:!1,error:"Both itemNo and serialNo are required."});try{let o=await R("Service_Item_Card","basic"),n={filter:[{Field:"Item_No",Criteria:t},{Field:"Serial_No",Criteria:s}],setSize:1};i("\u{1F4E8} NAV ReadMultiple params",n);let[a]=await o.ReadMultipleAsync(n);i("\u{1F4EC} NAV ReadMultiple result",a);let c=a?.ReadMultiple_Result?.Service_Item_Card?.[0];if(!c)return r.status(404).json({success:!1,message:`No service item found for Item_No=${t} and Serial_No=${s}.`});r.json({success:!0,data:c})}catch(o){console.error("\u274C NAV Fetch error:",o),r.status(500).json({success:!1,error:o.message})}});g.post("/service-items",async(e,r)=>{let t=e.body;if(console.log(`
\u{1F4E8} Received Service Item form data:`,t),!t?.itemNumber||!t?.serialNumber)return r.status(400).json({success:!1,error:"Item Number and Serial Number are required."});try{let s=await R("Service_Item_Card","basic"),o={...t};delete o.itemNumber,delete o.serialNumber,delete o.isNew,i("\u{1F680} NAV SOAP Payload",o);let[n]=t.isNew?await s.CreateAsync({Service_Item_Card:o}):await s.UpdateAsync({Service_Item_Card:o});i("\u{1F4E6} NAV SOAP Raw Response",n);let a=n?.Service_Item_Card||n?.Create_Result?.Service_Item_Card||n?.Update_Result?.Service_Item_Card||null;r.json({success:!0,data:a})}catch(s){console.error("\u274C NAV SOAP error:",s),r.status(500).json({success:!1,error:s.message})}});g.get("/customers",async(e,r)=>{let t=e.query.search;if(!t)return r.json({success:!0,data:[]});try{let s=await R("Customer_Card","ntlm"),o={filter:[{Field:"Name",Criteria:`*${t}*`}],setSize:10};i("\u{1F4E8} NAV Customer Search params",o);let[n]=await s.ReadMultipleAsync(o);i("\u{1F4EC} NAV Customer Search result",n);let a=n?.ReadMultiple_Result?.Customer_Card||n?.ReadMultiple_Result?.CustomerCard||[];r.json({success:!0,data:a})}catch(s){console.error("\u274C Error fetching customers:",s),r.status(500).json({success:!1,error:s.message})}});g.post("/customers",async(e,r)=>{let t=e.body;if(i("\u{1F4E8} Received Customer Form Data",t),!t.customerName)return r.status(400).json({success:!1,error:"Customer Name is required."});try{let s=await R("Customer_Card","ntlm"),o={Name:t.customerName,Title:t.title||"",ID_Number:t.idNumber||"",Customer_Group:t.customerGroup||"",Customer_Type_MRA:t.customerType||"",Address:t.address1||"",Address_2:t.address2||"",Post_Code:t.postCode||"",City:t.city||"",Country_Region_Code:t.country||"",Phone_No:t.phoneNumber||"",E_Mail:t.email||"",Fax_No:t.faxNumber||""};t.customerNumber&&(o.No=t.customerNumber),i("\u{1F680} NAV SOAP Create Payload",o);let[n]=await s.CreateAsync({Customer_Card:o});i("\u{1F4E6} NAV SOAP Raw Response",n);let a=n?.Customer_Card||n?.Create_Result?.Customer_Card||null;if(!a)throw new Error("NAV did not return a valid Customer Card.");r.json({success:!0,data:a})}catch(s){console.error("\u274C NAV SOAP Error:",s),r.status(500).json({success:!1,error:s.message})}});var U=g;var k=M(async()=>{console.log("[SSR] \u23F3 Connecting to MSSQL..."),await p(),console.log("[SSR] \u2705 MSSQL ready. Starting app...");let e=w();return e.disable("x-powered-by"),e.use((r,t,s)=>{t.set("Cache-Control","no-store"),s()}),e.use(ue()),e.use(w.json()),e.use(w.urlencoded({extended:!0})),e.use(le({secret:"4b7c9d8e2f1a3b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c",resave:!1,saveUninitialized:!1,cookie:{httpOnly:!0,secure:!1,sameSite:"lax"}})),e.use("/api/login",x),e.use("/soap",U),e.use("/api/db",Q),e.use((r,t,s)=>{let o=["/login"],a=["/public","/favicon","/src","/js","/css","/assets","/img","/@vite","/@fs","/@id","/__vite","/.quasar","/node_modules"].some(l=>r.path.startsWith(l)),c=o.some(l=>r.path.startsWith(l));if(r.path.startsWith("/api/login")||r.path.startsWith("/api/logout")||a||c)return s();if(!r.session?.user)return console.warn(`\u274C Unauthorized access attempt: ${r.path}`),t.redirect("/login");s()}),e.post("/api/logout",(r,t)=>{r.session.destroy(s=>{if(s)return console.error("Logout error:",s),t.status(500).json({success:!1,message:"Logout failed"});t.clearCookie("connect.sid"),t.json({success:!0,message:"Logged out successfully"})})}),e}),it=O(({app:e})=>r=>{e.use(r)}),W=I(({app:e,devHttpsApp:r,port:t})=>(r||e).listen(t,()=>{console.log("Server listening at port "+t)})),lt=T(({listenResult:e})=>e.close()),de=/\.js$/,me=/\.css$/,pe=/\.woff$/,fe=/\.woff2$/,Se=/\.gif$/,ge=/\.jpe?g$/,ve=/\.png$/,q=$(({app:e,resolve:r})=>({urlPath:t="/",pathToServe:s=".",opts:o={}})=>{let n=w.static(r.public(s),{maxAge:0,...o});e.use(r.urlPath(t),n)}),P=D(e=>de.test(e)?`<link rel="modulepreload" href="${e}" crossorigin>`:me.test(e)?`<link rel="stylesheet" href="${e}" crossorigin>`:pe.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff" crossorigin>`:fe.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff2" crossorigin>`:Se.test(e)?`<link rel="preload" href="${e}" as="image" type="image/gif" crossorigin>`:ge.test(e)?`<link rel="preload" href="${e}" as="image" type="image/jpeg" crossorigin>`:ve.test(e)?`<link rel="preload" href="${e}" as="image" type="image/png" crossorigin>`:"");function E(e){return Promise.all([Promise.resolve().then(()=>(G(),B))]).then(async r=>{let t=r.map(s=>s.default);for(let s=0;s<t.length;s++)try{await t[s](e)}catch(o){console.error("[Quasar SSR] middleware error:",o);return}})}var Ee=process.env.PORT||3e3,Le=/\/\//g,y="/",je=y==="/"?e=>e||"/":e=>e?(y+e).replace(Le,"/"):y,_=_e(new URL(".",import.meta.url)),z=v(_,"client"),L=JSON.parse(ye(v(_,"./quasar.manifest.json"),"utf-8"));function be(){let e=v(...arguments);return we(e)===!0?e:v(z,e)}function Me(e,r){let t="",s=new Set;return e.forEach(o=>{let n=L[o];n!==void 0&&n.forEach(a=>{if(s.has(a)===!0)return;s.add(a);let c=Re(a);if(L[c]!==void 0)for(let l of L[c])s.has(l)===!1&&(t+=P(l,r),s.add(l));t+=P(a,r)})}),t}var Oe="document.currentScript.remove()";function Ie(e){let r=e.nonce!==void 0?' nonce="'+e.nonce+'"':"",t=Ne(e.state,{isJSON:!0});return"<script"+r+">window.__INITIAL_STATE__="+t+";"+Oe+"</script>"}async function Te(e){let r=[];Object.assign(e,{_meta:{},onRendered:t=>{r.push(t)}});try{let t=await Pe(e),s=await Ae(t,e);return r.forEach(o=>{o()}),typeof e.rendered=="function"&&e.rendered(),e._meta.runtimePageContent=s,e.state!==void 0&&(e._meta.headTags=Ie(e)+e._meta.headTags),e._meta.endingHeadTags+=Me(e.modules,{ssrContext:e}),Ce(e)}catch(t){throw t}}var f={port:Ee,resolve:{urlPath:je,root(){return v(_,...arguments)},public:be},publicPath:y,folders:{root:_,public:z},render:Te},$e=await k(f);f.app=$e;var H=await q(f);f.serve={static:H};await H({urlPath:"/",pathToServe:"."});await E(f);var De=await W(f),_t=De?.handler;export{$e as app,_t as handler,De as listenResult};
