var X=Object.defineProperty;var O=(e,r)=>()=>(e&&(r=e(e=0)),r);var Y=(e,r)=>{for(var t in r)X(e,t,{get:r[t],enumerable:!0})};var u,j,b,I,D,T,V,$,y=O(()=>{u=e=>e,j=u,b=u,I=u,D=u,T=u,V=u,$=u});var G={};Y(G,{default:()=>Re});var Re,z=O(()=>{y();Re=j(({app:e,resolve:r,render:t,serve:s})=>{e.get(r.urlPath("*"),(n,o)=>{o.setHeader("Content-Type","text/html"),t({req:n,res:o}).then(a=>{o.send(a)}).catch(a=>{a.url?a.code?o.redirect(a.code,a.url):o.redirect(a.url):a.code===404?o.status(404).send("404 | Page Not Found"):o.status(500).send("500 | Internal Server Error")})})})});import{join as g,basename as we,isAbsolute as he}from"node:path";import{readFileSync as Ne}from"node:fs";import{fileURLToPath as _e}from"node:url";import{renderToString as ye}from"vue/server-renderer";import Ae from"serialize-javascript";import Ce from"./render-template.js";import Pe from"./server/server-entry.js";y();import w from"express";import le from"express-session";import ue from"compression";import{Router as oe}from"express";import Z from"mssql";import ee from"dotenv";ee.config();var te={user:"sa",password:"1234",server:"192.168.8.131",database:"FORTRESS_LIVE",options:{encrypt:!1,trustServerCertificate:!0}},p=null,x=null;function re(e){return new Promise(r=>setTimeout(r,e))}async function m(e=5,r=3e3){if(p)return p;let t=0;for(;t<e;)try{return console.log(`[MSSQL] \u{1F50C} Connecting (attempt ${t+1}/${e})...`),p=await Z.connect(te),console.log("[MSSQL] \u2705 Connected to database"),se(),p}catch(s){if(console.error(`[MSSQL] \u274C Connection failed (attempt ${t+1}):`,s.message),t++,t<e)console.log(`[MSSQL] \u23F3 Retrying in ${r/1e3}s...`),await re(r);else throw console.error("[MSSQL] \u274C All connection attempts failed. Server startup aborted."),s}}function se(e=300*1e3){x||(console.log(`[MSSQL] \u{1FA7A} Starting keep-alive ping every ${e/1e3/60} min`),x=setInterval(async()=>{try{if(!p)return;await p.request().query("SELECT 1"),console.log("[MSSQL] \u2705 Keep-alive ping successful")}catch(r){console.error("[MSSQL] \u26A0\uFE0F Keep-alive ping failed:",r.message)}},e))}import ne from"dotenv";ne.config();var v=oe();v.post("/login",async(e,r)=>{let{username:t,password:s}=e.body;if(!t||!s)return r.status(400).json({success:!1,message:"Missing credentials"});try{let o=await(await m()).request().input("login",t).input("password",s).query(`
      SELECT Login, Name
      FROM dbo.VW_WA_UserList
      WHERE Login = @login AND Password = @password
    `);if(o.recordset.length===0)return r.status(401).json({success:!1,message:"Invalid credentials"});let a={username:o.recordset[0].Login,name:o.recordset[0].Name};return e.session.user=a,r.json({success:!0,message:"Login successful",user:a})}catch(n){return console.error("[LOGIN ERROR]",n),r.status(500).json({success:!1,error:"Internal Server Error"})}});v.post("/logout",(e,r)=>{e.session.destroy(t=>{if(t)return console.error("Logout error:",t),r.status(500).json({success:!1,message:"Logout failed"});r.clearCookie("connect.sid"),r.json({success:!0,message:"Logged out successfully"})})});v.get("/session",(e,r)=>e.session?.user?r.json({loggedIn:!!e.session?.user,user:e.session?.user||null}):r.json({loggedIn:!1}));var U=v;import{Router as ae}from"express";var F=ae();F.get("/itemlist",async(e,r)=>{try{let s=await(await m()).request().query(`
      SELECT * FROM VW_WA_ItemList
    `);return r.json({success:!0,data:s.recordset})}catch(t){return console.error("[DB ERROR]",t),r.status(500).json({success:!1,error:"Database query failed"})}});var Q=F;import ce from"express";import R from"soap";import ie from"util";var S=ce.Router();function l(e,r){let t=new Date().toISOString();console.log(`
\u{1F9ED} [${t}] ${e}:`),console.log(ie.inspect(r,{colors:!0,depth:null,compact:!1}))}async function A(e="Service_Item_Card"){let r="fortress\\administrator",t="P@ssw0rdNAV25***",s="SRVNAV",n=`http://sapmobile:7047/DynamicsNAV110/WS/CRONUS%20UK%20Ltd./Page/${e}?wsdl`;try{let o=new R.NTLMSecurity({username:r,password:t,domain:s,negotiate:!0}),a={},c={};o.addHeaders(a),o.addOptions(c);let i=await R.createClientAsync(n,{wsdl_headers:a,wsdl_options:c});return i.setSecurity(o),i.on("request",d=>{console.log(`
\u{1F4E4} NAV SOAP REQUEST:
`,d)}),i.on("response",d=>{console.log(`
\u{1F4E5} NAV SOAP RESPONSE:
`,d)}),l("\u2705 NAV SOAP Client created",{WSDL_URL:n,NAVUSERNAME:r,DOMAIN:s}),i}catch(o){throw console.error("\u274C Failed to create NAV SOAP client:",o),o}}S.get("/service-items",async(e,r)=>{let{itemNo:t,serialNo:s}=e.query;if(!t||!s)return r.status(400).json({success:!1,error:"Both itemNo and serialNo are required."});try{let n=await A("Service_Item_Card"),o={filter:[{Field:"Item_No",Criteria:t},{Field:"Serial_No",Criteria:s}],setSize:1};l("\u{1F4E8} NAV ReadMultiple params",o);let[a]=await n.ReadMultipleAsync(o);l("\u{1F4EC} NAV ReadMultiple result",a);let c=a?.ReadMultiple_Result?.Service_Item_Card?.[0];if(!c)return l("\u26A0\uFE0F No item found",{itemNo:t,serialNo:s}),r.status(404).json({success:!1,message:`No service item found for Item_No=${t} and Serial_No=${s}.`});r.json({success:!0,data:c})}catch(n){console.error("\u274C NAV Fetch error:",n),r.status(500).json({success:!1,error:n.message})}});S.post("/service-items",async(e,r)=>{let t=e.body;if(console.log(`
\u{1F4E8} Received Service Item form data:`,t),!t?.itemNumber||!t?.serialNumber)return r.status(400).json({success:!1,error:"Item Number and Serial Number are required."});try{let s=await A("Service_Item_Card"),n={...t};delete n.itemNumber,delete n.serialNumber,delete n.isNew,l("\u{1F680} NAV SOAP Payload",n);let[o]=t.isNew?await s.CreateAsync({Service_Item_Card:n}):await s.UpdateAsync({Service_Item_Card:n});l("\u{1F4E6} NAV SOAP Raw Response",o);let a=o?.Service_Item_Card||o?.Create_Result?.Service_Item_Card||o?.Update_Result?.Service_Item_Card||null;r.json({success:!0,data:a})}catch(s){console.error("\u274C NAV SOAP error:",s),r.status(500).json({success:!1,error:s.message})}});S.get("/customers",async(e,r)=>{let t=e.query.search;if(!t)return r.json({success:!0,data:[]});let s="fortress\\administrator",n="P@ssw0rdNAV25***",o="SRVNAV",a="http://srvnav:7047/DynamicsNAV110/WS/FORTRESS_LIVE/Page/Customer_Card?wsdl";try{let c=new R.NTLMSecurity({username:s,password:n,domain:o,negotiate:!0}),i={},d={};c.addHeaders(i),c.addOptions(d);let L=await R.createClientAsync(a,{wsdl_headers:i,wsdl_options:d});L.setSecurity(c);let M={filter:[{Field:"Search_Name",Criteria:`*${t}*`}],setSize:10};console.log(`
\u{1F4E8} NAV Customer Search params:`,M);let[_]=await L.ReadMultipleAsync(M);console.log(`
\u{1F4EC} NAV Customer Search result:`,_);let J=_?.ReadMultiple_Result?.CustomerCard||_?.ReadMultiple_Result?.Customer_Card||[];r.json({success:!0,data:J})}catch(c){console.error("\u274C Error fetching customers:",c),r.status(500).json({success:!1,error:c.message})}});S.post("/customers",async(e,r)=>{let t=e.body;if(l("\u{1F4E8} Received Customer Form Data",t),!t.customerName)return r.status(400).json({success:!1,error:"Customer Name is required."});try{let s=await A("CustomerCard"),n={Name:t.customerName,Title:t.title||"",ID_Number:t.idNumber||"",Customer_Group:t.customerGroup||"",Customer_Type_MRA:t.customerType||"",Address:t.address1||"",Address_2:t.address2||"",Post_Code:t.postCode||"",City:t.city||"",Country_Region_Code:t.country||"",Phone_No:t.phoneNumber||"",E_Mail:t.email||"",Fax_No:t.faxNumber||""};t.customerNumber&&(n.No=t.customerNumber),l("\u{1F680} NAV SOAP Create Payload",n);let[o]=await s.CreateAsync({CustomerCard:n});l("\u{1F4E6} NAV SOAP Raw Response",o);let a=o?.CustomerCard||o?.Create_Result?.CustomerCard||null;if(!a)throw new Error("NAV did not return a valid CustomerCard.");r.json({success:!0,data:a})}catch(s){console.error("\u274C NAV SOAP Error:",s),r.status(500).json({success:!1,error:s.message})}});var W=S;var k=b(async()=>{console.log("[SSR] \u23F3 Connecting to MSSQL..."),await m(),console.log("[SSR] \u2705 MSSQL ready. Starting app...");let e=w();return e.disable("x-powered-by"),e.use((r,t,s)=>{t.set("Cache-Control","no-store"),s()}),e.use(ue()),e.use(w.json()),e.use(w.urlencoded({extended:!0})),e.use(le({secret:"4b7c9d8e2f1a3b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c",resave:!1,saveUninitialized:!1,cookie:{httpOnly:!0,secure:!1,sameSite:"lax"}})),e.use("/api/login",U),e.use("/soap",W),e.use("/api/db",Q),e.use((r,t,s)=>{let n=["/login"],a=["/public","/favicon","/src","/js","/css","/assets","/img","/@vite","/@fs","/@id","/__vite","/.quasar","/node_modules"].some(i=>r.path.startsWith(i)),c=n.some(i=>r.path.startsWith(i));if(r.path.startsWith("/api/login")||r.path.startsWith("/api/logout")||a||c)return s();if(!r.session?.user)return console.warn(`\u274C Unauthorized access attempt: ${r.path}`),t.redirect("/login");s()}),e.post("/api/logout",(r,t)=>{r.session.destroy(s=>{if(s)return console.error("Logout error:",s),t.status(500).json({success:!1,message:"Logout failed"});t.clearCookie("connect.sid"),t.json({success:!0,message:"Logged out successfully"})})}),e}),ct=I(({app:e})=>r=>{e.use(r)}),q=D(({app:e,devHttpsApp:r,port:t})=>(r||e).listen(t,()=>{console.log("Server listening at port "+t)})),it=T(({listenResult:e})=>e.close()),de=/\.js$/,pe=/\.css$/,me=/\.woff$/,fe=/\.woff2$/,Se=/\.gif$/,ge=/\.jpe?g$/,ve=/\.png$/,B=V(({app:e,resolve:r})=>({urlPath:t="/",pathToServe:s=".",opts:n={}})=>{let o=w.static(r.public(s),{maxAge:0,...n});e.use(r.urlPath(t),o)}),C=$(e=>de.test(e)?`<link rel="modulepreload" href="${e}" crossorigin>`:pe.test(e)?`<link rel="stylesheet" href="${e}" crossorigin>`:me.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff" crossorigin>`:fe.test(e)?`<link rel="preload" href="${e}" as="font" type="font/woff2" crossorigin>`:Se.test(e)?`<link rel="preload" href="${e}" as="image" type="image/gif" crossorigin>`:ge.test(e)?`<link rel="preload" href="${e}" as="image" type="image/jpeg" crossorigin>`:ve.test(e)?`<link rel="preload" href="${e}" as="image" type="image/png" crossorigin>`:"");function P(e){return Promise.all([Promise.resolve().then(()=>(z(),G))]).then(async r=>{let t=r.map(s=>s.default);for(let s=0;s<t.length;s++)try{await t[s](e)}catch(n){console.error("[Quasar SSR] middleware error:",n);return}})}var Ee=process.env.PORT||3e3,Le=/\/\//g,h="/",Me=h==="/"?e=>e||"/":e=>e?(h+e).replace(Le,"/"):h,N=_e(new URL(".",import.meta.url)),H=g(N,"client"),E=JSON.parse(Ne(g(N,"./quasar.manifest.json"),"utf-8"));function Oe(){let e=g(...arguments);return he(e)===!0?e:g(H,e)}function je(e,r){let t="",s=new Set;return e.forEach(n=>{let o=E[n];o!==void 0&&o.forEach(a=>{if(s.has(a)===!0)return;s.add(a);let c=we(a);if(E[c]!==void 0)for(let i of E[c])s.has(i)===!1&&(t+=C(i,r),s.add(i));t+=C(a,r)})}),t}var be="document.currentScript.remove()";function Ie(e){let r=e.nonce!==void 0?' nonce="'+e.nonce+'"':"",t=Ae(e.state,{isJSON:!0});return"<script"+r+">window.__INITIAL_STATE__="+t+";"+be+"</script>"}async function De(e){let r=[];Object.assign(e,{_meta:{},onRendered:t=>{r.push(t)}});try{let t=await Pe(e),s=await ye(t,e);return r.forEach(n=>{n()}),typeof e.rendered=="function"&&e.rendered(),e._meta.runtimePageContent=s,e.state!==void 0&&(e._meta.headTags=Ie(e)+e._meta.headTags),e._meta.endingHeadTags+=je(e.modules,{ssrContext:e}),Ce(e)}catch(t){throw t}}var f={port:Ee,resolve:{urlPath:Me,root(){return g(N,...arguments)},public:Oe},publicPath:h,folders:{root:N,public:H},render:De},Te=await k(f);f.app=Te;var K=await B(f);f.serve={static:K};await K({urlPath:"/",pathToServe:"."});await P(f);var Ve=await q(f),Nt=Ve?.handler;export{Te as app,Nt as handler,Ve as listenResult};
